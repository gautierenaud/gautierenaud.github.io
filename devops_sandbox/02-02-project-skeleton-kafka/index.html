<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>02-02 Project Skeleton - Kafka | RGDG</title><meta name=keywords content="kafka,statefulset,k8s"><meta name=description content="Kafka What is one of the component I often use at work? You guessed it, Kafka. For those who don&rsquo;t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle Observability?"><meta name=author content><link rel=canonical href=https://gautierenaud.github.io/devops_sandbox/02-02-project-skeleton-kafka/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://gautierenaud.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gautierenaud.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gautierenaud.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gautierenaud.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gautierenaud.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="02-02 Project Skeleton - Kafka"><meta property="og:description" content="Kafka What is one of the component I often use at work? You guessed it, Kafka. For those who don&rsquo;t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle Observability?"><meta property="og:type" content="article"><meta property="og:url" content="https://gautierenaud.github.io/devops_sandbox/02-02-project-skeleton-kafka/"><meta property="article:section" content="devops_sandbox"><meta property="article:published_time" content="2023-02-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="02-02 Project Skeleton - Kafka"><meta name=twitter:description content="Kafka What is one of the component I often use at work? You guessed it, Kafka. For those who don&rsquo;t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle Observability?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"DevOps Sandbox","item":"https://gautierenaud.github.io/devops_sandbox/"},{"@type":"ListItem","position":3,"name":"02-02 Project Skeleton - Kafka","item":"https://gautierenaud.github.io/devops_sandbox/02-02-project-skeleton-kafka/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"02-02 Project Skeleton - Kafka","name":"02-02 Project Skeleton - Kafka","description":"Kafka What is one of the component I often use at work? You guessed it, Kafka. For those who don\u0026rsquo;t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle Observability?","keywords":["kafka","statefulset","k8s"],"articleBody":"Kafka What is one of the component I often use at work? You guessed it, Kafka. For those who don’t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle Observability?)\nCurrently, you need 2 type of components to leverage Kafka:\nthe Brokers that will handle all the actual streaming of messages\nZookeeper that will coordinate the brokers\nHaving 2 components means 2 configurations to get right, and even more occasions to make errors. As such, there is an ongoing effort to get rid of Zookeeper, and only have the brokers. This new approach is called KRaft, and the brokers will now communicate through a dedicated topic to share information, instead of going through Zookeeper. The only issue is that it is still a work in progress (02/2023), so it should not be used in production yet. However, this should not stop me for my experimentations.\nService service.yaml\napiVersion: v1 kind: Service metadata: name: kafka-svc labels: app: kafka-app\tspec: clusterIP: None ports: - name: '9092' port: 9092 protocol: TCP targetPort: 9092 selector: app: kafka-app You can see with clusterIP: None that no IP is assigned to the service. It is called a Headless Service, and is used when there is no need for load balancing, and the access to the service will be done through its name, e.g. kafka-svc:9092 in this specific case.\nStatefulset statefulset.yaml\napiVersion: apps/v1 kind: StatefulSet metadata: name: kafka labels: app: kafka-app spec: serviceName: kafka-svc replicas: 1 selector: matchLabels: app: kafka-app template: metadata: labels: app: kafka-app spec: containers: - name: kafka-container image: bashj79/kafka-kraft:latest ports: - containerPort: 9092 - containerPort: 9093 env: - name: KAFKA_ADVERTISED_LISTENERS value: PLAINTEXT://kafka-svc:9092,CONTROLLER://kafka-svc:9093 - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP value: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT volumeMounts: - name: data mountPath: /mnt/kafka volumeClaimTemplates: - metadata: name: data spec: accessModes: - \"ReadWriteOnce\" resources: requests: storage: \"1Gi\" This is my first time with Statefulsets! It can be seen as a Deployment that will automatically create a PersistentVolume and the corresponding PersistentVolumeClaim. The interesting thing with Statefulsets is that they are “sticky”: if a pod needs to be redeployed, it will have the same name (e.g. name-0, name-1, …) and will bind to the same volume (e.g. name-0 will always bind to volume-0).\nThe image I’ve used (bashj79/kafka-kraft:latest) is a Kafka image enabling KRaft with a default configuration. My guess is that the biggest difference with usual Kafka images lies in the KRaft-specific configuration, where the following fields (among others) are filled:\nnode.id=1 process.roles=broker,controller controller.listener.names=CONTROLLER controller.quorum.voters=1@localhost:9093 I initially thought that this was enough for redundancy, and increasing the number of replicas would be enough. But I’ll detail it in the following section…\nChecks As a programmer, I’ve learned that “testing is doubting” and bad things happen only when you are looking. So I started looking.\nNetwork checks Once applied (kubectl apply -k .) I can see my service/pod happily running! (I aliased kubectl as k)\n$ k get service NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kafka-svc ClusterIP None 9092/TCP 46m $ k get pods NAME READY STATUS RESTARTS AGE kafka-0 1/1 Running 0 6m31s First I was not sure how to communicate with my service: it does not have an IP, and what is its name? For this I will use nslookup from a pod:\n$ k run dig --rm -ti --image arunvelsriram/utils -- bash utils@dig:~$ nslookup kafka-svc Server:\t10.96.0.10 Address:\t10.96.0.10#53 Name:\tkafka-svc.default.svc.cluster.local Address: 10.244.0.9 So using the service name kafka-svc seems to be enough! Also, it returned me a Fully Qualified Domain Name (FQDN) (kafka-svc.default.svc.cluster.local) with it’s associated IP. This corresponds to the single pod I’ve deployed, and sure enough prepending the pod name (e.g. kafka-0) to the FQDN will yield:\nutils@dig:~$ dig kafka-0.kafka-svc.default.svc.cluster.local [...] ;; ANSWER SECTION: kafka-0.kafka-svc.default.svc.cluster.local. 30\tIN A 10.244.0.9 It’s the same IP we’ve seen above!\nWith multiple replicas, nslookup kafka-svc will return multiple results, one for each replica. It’s just that when connecting to kafka-svc, sometimes it will be kafka-0.kafka-svc.default.svc.cluster.local, or kafka-1.kafka-svc.default.svc.cluster.local, or kafka-2.kafka-svc.default.svc.cluster.local. This, coupled with a bad understanding of how the brokers were syncing, led me to several headaches…\nKafka checks So far everything was fine, and I boldly decided to test if I can publish/consume on my kafka topics. To do so I used to following commands:\n$ k run kafka-client --rm -ti --image bitnami/kafka:3.1.0 -- bash # if already running $ k exec kafka-client -ti -- bash # Consume $ kafka-console-consumer.sh --topic first_topic --bootstrap-server kafka-svc:9092 # Produce I have no name!@kafka-client:/$ kafka-console-producer.sh --topic first_topic --bootstrap-server kafka-svc:9092 As far as I’m concerned, it seems to be working (producer on left, consumer on right):\nHowever, increasing the number of replicas (in the statefulset.yaml file) seems to break things. Indeed, sometimes my consumers will straight up ignore the producers, while sometimes talking to each other nicely. I was puzzled, until I reduced the number of replicas back to 1, where everything was working nicely.\nThat’s when I realized my issue with the configuration, and how naive I was thinking that increasing the replicas will just magically work. The default configuration was always assigning the same node id, and the voter was always the same (1@localhost:9093). What I need is probably a node id aligned with the Statefulset’s id (e.g. kafka-0 should have node.id=0) and a list of voters with the proper FQDN (0@kafka-0.kafka-svc.default.svc.cluster.local:9093,1@kafka-1.kafka-svc.default.svc.cluster.local:9093,2@kafka-2.kafka-svc.default.svc.cluster.local:9093 for 3 replicas).\nHowever, this is beyond the current scope (I just want to make a skeleton), and I’ll probably need to dig into making my own container image, generate a configuration file specific to a pod (maybe just the node.id?), while making sure all is working with whatever number of replicas I want. I’ll probably tackle those problems specifically when looking into resiliency.\nTakeaways Statefulsets are cool: they are Deployments with sticky volumes.\nResiliency is not magical, it is done on the software level with some elbow grease.\nTesting is doubting.\nJust kidding: the process is frustrating, but it is a good way to check the state of my understanding.\n","wordCount":"1033","inLanguage":"en","datePublished":"2023-02-14T00:00:00Z","dateModified":"2023-02-16T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://gautierenaud.github.io/devops_sandbox/02-02-project-skeleton-kafka/"},"publisher":{"@type":"Organization","name":"RGDG","logo":{"@type":"ImageObject","url":"https://gautierenaud.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gautierenaud.github.io accesskey=h title="RGDG (Alt + H)">RGDG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gautierenaud.github.io>Home</a>&nbsp;»&nbsp;<a href=https://gautierenaud.github.io/devops_sandbox/>DevOps Sandbox</a></div><h1 class=post-title>02-02 Project Skeleton - Kafka</h1><div class=post-meta><span title='2023-02-14 00:00:00 +0000 UTC'>February 14, 2023</span>&nbsp;·&nbsp;5 min</div></header><div class=post-content><h1 id=kafka>Kafka<a hidden class=anchor aria-hidden=true href=#kafka>#</a></h1><p>What is one of the component I often use at work? You guessed it, <a href=https://kafka.apache.org/>Kafka</a>. For those who don&rsquo;t know, Kafka can be seen as a messaging system (the exact term is streaming platform), where some will publish messages (Producers) while others will process them (Consumers). It is made to scale, so it is obviously overkill for a personal project, but the goal was to experiment with it. Also, I will not delve here into the details of Kafka now (maybe when I tackle <a href=https://en.wikipedia.org/wiki/Observability>Observability</a>?)</p><p>Currently, you need 2 type of components to leverage Kafka:</p><ul><li><p>the Brokers that will handle all the actual streaming of messages</p></li><li><p><a href=https://zookeeper.apache.org/>Zookeeper</a> that will coordinate the brokers</p></li></ul><p>Having 2 components means 2 configurations to get right, and even more occasions to make errors. As such, there is an ongoing effort to get rid of Zookeeper, and only have the brokers. This new approach is called <a href=https://developer.confluent.io/learn/kraft/>KRaft</a>, and the brokers will now communicate through a dedicated topic to share information, instead of going through Zookeeper. The only issue is that it is still a work in progress (02/2023), so it should not be used in production yet. However, this should not stop me for my experimentations.</p><h2 id=service>Service<a hidden class=anchor aria-hidden=true href=#service>#</a></h2><p><code>service.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kafka-app	</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterIP</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;9092&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kafka-app</span>
</span></span></code></pre></div><p>You can see with <code>clusterIP: None</code> that no IP is assigned to the service. It is called a <strong>Headless Service</strong>, and is used when there is no need for load balancing, and the access to the service will be done through its name, e.g. <code>kafka-svc:9092</code> in this specific case.</p><h2 id=statefulset>Statefulset<a hidden class=anchor aria-hidden=true href=#statefulset>#</a></h2><p><code>statefulset.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kafka-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>kafka-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kafka-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>kafka-app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kafka-container</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>bashj79/kafka-kraft:latest</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9092</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>9093</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>KAFKA_ADVERTISED_LISTENERS</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>PLAINTEXT://kafka-svc:9092,CONTROLLER://kafka-svc:9093</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>value</span>: <span style=color:#ae81ff>PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/mnt/kafka</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeClaimTemplates</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;1Gi&#34;</span>
</span></span></code></pre></div><p>This is my first time with <a href=https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/>Statefulsets</a>! It can be seen as a Deployment that will automatically create a <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/>PersistentVolume</a> and the corresponding PersistentVolumeClaim. The interesting thing with Statefulsets is that they are &ldquo;sticky&rdquo;: if a pod needs to be redeployed, it will have the same name (e.g. <code>name-0</code>, <code>name-1</code>, &mldr;) and will bind to the same volume (e.g. <code>name-0</code> will always bind to <code>volume-0</code>).</p><p>The image I&rsquo;ve used (<code>bashj79/kafka-kraft:latest</code>) is a Kafka image enabling KRaft with a default configuration. My guess is that the biggest difference with usual Kafka images lies in the KRaft-specific configuration, where the following fields (among others) are filled:</p><pre tabindex=0><code>node.id=1
process.roles=broker,controller
controller.listener.names=CONTROLLER
controller.quorum.voters=1@localhost:9093
</code></pre><p>I initially thought that this was enough for redundancy, and increasing the number of replicas would be enough. But I&rsquo;ll detail it in the following section&mldr;</p><h2 id=checks>Checks<a hidden class=anchor aria-hidden=true href=#checks>#</a></h2><p>As a programmer, I&rsquo;ve learned that &ldquo;testing is doubting&rdquo; and bad things happen only when you are looking. So I started looking.</p><h3 id=network-checks>Network checks<a hidden class=anchor aria-hidden=true href=#network-checks>#</a></h3><p>Once applied (<code>kubectl apply -k .</code>) I can see my service/pod happily running! (I aliased <code>kubectl</code> as <code>k</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k get service
</span></span><span style=display:flex><span>NAME           TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>    AGE
</span></span><span style=display:flex><span>kafka-svc      ClusterIP   None         &lt;none&gt;        9092/TCP   46m
</span></span><span style=display:flex><span>$ k get pods
</span></span><span style=display:flex><span>NAME           READY   STATUS    RESTARTS       AGE
</span></span><span style=display:flex><span>kafka-0        1/1     Running   <span style=color:#ae81ff>0</span>              6m31s
</span></span></code></pre></div><p>First I was not sure how to communicate with my service: it does not have an IP, and what is its name? For this I will use <code>nslookup</code> from a pod:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k run dig --rm -ti --image arunvelsriram/utils -- bash
</span></span><span style=display:flex><span>utils@dig:~$ nslookup kafka-svc
</span></span><span style=display:flex><span>Server:		10.96.0.10
</span></span><span style=display:flex><span>Address:	10.96.0.10#53
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Name:	kafka-svc.default.svc.cluster.local
</span></span><span style=display:flex><span>Address: 10.244.0.9
</span></span></code></pre></div><p>So using the service name <code>kafka-svc</code> seems to be enough! Also, it returned me a <a href=https://fr.wikipedia.org/wiki/Fully_qualified_domain_name>Fully Qualified Domain Name (FQDN)</a> (<code>kafka-svc.default.svc.cluster.local</code>) with it&rsquo;s associated IP. This corresponds to the single pod I&rsquo;ve deployed, and sure enough prepending the pod name (e.g. <code>kafka-0</code>) to the FQDN will yield:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>utils@dig:~$ dig kafka-0.kafka-svc.default.svc.cluster.local
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>kafka-0.kafka-svc.default.svc.cluster.local. 30	IN A 10.244.0.9
</span></span></code></pre></div><p>It&rsquo;s the same IP we&rsquo;ve seen above!</p><p>With multiple replicas, <code>nslookup kafka-svc</code> will return multiple results, one for each replica. It&rsquo;s just that when connecting to <code>kafka-svc</code>, sometimes it will be <code>kafka-0.kafka-svc.default.svc.cluster.local</code>, or <code>kafka-1.kafka-svc.default.svc.cluster.local</code>, or <code>kafka-2.kafka-svc.default.svc.cluster.local</code>. This, coupled with a bad understanding of how the brokers were syncing, led me to several headaches&mldr;</p><h3 id=kafka-checks>Kafka checks<a hidden class=anchor aria-hidden=true href=#kafka-checks>#</a></h3><p>So far everything was fine, and I boldly decided to test if I can publish/consume on my kafka topics. To do so I used to following commands:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k run kafka-client --rm -ti --image bitnami/kafka:3.1.0 -- bash
</span></span><span style=display:flex><span><span style=color:#75715e># if already running</span>
</span></span><span style=display:flex><span>$ k exec kafka-client -ti -- bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Consume</span>
</span></span><span style=display:flex><span>$ kafka-console-consumer.sh --topic first_topic --bootstrap-server kafka-svc:9092
</span></span><span style=display:flex><span><span style=color:#75715e># Produce</span>
</span></span><span style=display:flex><span>I have no name!@kafka-client:/$ kafka-console-producer.sh --topic first_topic --bootstrap-server kafka-svc:9092
</span></span></code></pre></div><p>As far as I&rsquo;m concerned, it seems to be working (producer on left, consumer on right):</p><p><img loading=lazy src=/assets/image_1676233158650_0.png alt=image.png></p><p>However, increasing the number of replicas (in the <code>statefulset.yaml</code> file) seems to break things. Indeed, sometimes my consumers will straight up ignore the producers, while sometimes talking to each other nicely. I was puzzled, until I reduced the number of replicas back to 1, where everything was working nicely.</p><p>That&rsquo;s when I realized my issue with the configuration, and how naive I was thinking that increasing the replicas will just magically work. The default configuration was always assigning the same node id, and the voter was always the same (<code>1@localhost:9093</code>). What I need is probably a node id aligned with the Statefulset&rsquo;s id (e.g. <code>kafka-0</code> should have <code>node.id=0</code>) and a list of voters with the proper FQDN (<code>0@kafka-0.kafka-svc.default.svc.cluster.local:9093,1@kafka-1.kafka-svc.default.svc.cluster.local:9093,2@kafka-2.kafka-svc.default.svc.cluster.local:9093</code> for 3 replicas).</p><p>However, this is beyond the current scope (I just want to make a skeleton), and I&rsquo;ll probably need to dig into making my own container image, generate a configuration file specific to a pod (maybe just the <code>node.id</code>?), while making sure all is working with whatever number of replicas I want. I&rsquo;ll probably tackle those problems specifically when looking into resiliency.</p><h2 id=takeaways>Takeaways<a hidden class=anchor aria-hidden=true href=#takeaways>#</a></h2><p>Statefulsets are cool: they are Deployments with sticky volumes.</p><p>Resiliency is not magical, it is done on the software level with some elbow grease.</p><p>Testing is doubting.</p><p>Just kidding: the process is frustrating, but it is a good way to check the state of my understanding.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://gautierenaud.github.io/tags/kafka/>kafka</a></li><li><a href=https://gautierenaud.github.io/tags/statefulset/>statefulset</a></li><li><a href=https://gautierenaud.github.io/tags/k8s/>k8s</a></li></ul><nav class=paginav><a class=prev href=https://gautierenaud.github.io/devops_sandbox/02-01-project-skeleton-local-kubernetes/><span class=title>« Prev</span><br><span>02-01 Project Skeleton - Local Kubernetes</span></a>
<a class=next href=https://gautierenaud.github.io/devops_sandbox/02-03-project-skeleton-postgresql/><span class=title>Next »</span><br><span>02-03 Project Skeleton - PostgreSQL</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://gautierenaud.github.io>RGDG</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>