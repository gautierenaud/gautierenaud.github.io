<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>02-03 Project Skeleton - PostgreSQL | RGDG</title><meta name=keywords content="postgres,statefulset,k8s"><meta name=description content="PostgreSQL I&rsquo;ve chosen PostgreSQL for the same reason as Kafka: I&rsquo;m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I&rsquo;ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.
Service service.yaml
apiVersion: v1 kind: Service metadata: name: postgres-svc labels: app: postgres-app spec: clusterIP: None ports: - name: '5432' port: 5432 protocol: TCP targetPort: 5432 selector: app: postgres-app Again, a Headless service (as with Kafka)."><meta name=author content><link rel=canonical href=https://gautierenaud.github.io/devops_sandbox/02-03-project-skeleton-postgresql/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://gautierenaud.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gautierenaud.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gautierenaud.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://gautierenaud.github.io/apple-touch-icon.png><link rel=mask-icon href=https://gautierenaud.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="02-03 Project Skeleton - PostgreSQL"><meta property="og:description" content="PostgreSQL I&rsquo;ve chosen PostgreSQL for the same reason as Kafka: I&rsquo;m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I&rsquo;ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.
Service service.yaml
apiVersion: v1 kind: Service metadata: name: postgres-svc labels: app: postgres-app spec: clusterIP: None ports: - name: '5432' port: 5432 protocol: TCP targetPort: 5432 selector: app: postgres-app Again, a Headless service (as with Kafka)."><meta property="og:type" content="article"><meta property="og:url" content="https://gautierenaud.github.io/devops_sandbox/02-03-project-skeleton-postgresql/"><meta property="article:section" content="devops_sandbox"><meta property="article:published_time" content="2023-02-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-16T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="02-03 Project Skeleton - PostgreSQL"><meta name=twitter:description content="PostgreSQL I&rsquo;ve chosen PostgreSQL for the same reason as Kafka: I&rsquo;m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I&rsquo;ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.
Service service.yaml
apiVersion: v1 kind: Service metadata: name: postgres-svc labels: app: postgres-app spec: clusterIP: None ports: - name: '5432' port: 5432 protocol: TCP targetPort: 5432 selector: app: postgres-app Again, a Headless service (as with Kafka)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"DevOps Sandbox","item":"https://gautierenaud.github.io/devops_sandbox/"},{"@type":"ListItem","position":3,"name":"02-03 Project Skeleton - PostgreSQL","item":"https://gautierenaud.github.io/devops_sandbox/02-03-project-skeleton-postgresql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"02-03 Project Skeleton - PostgreSQL","name":"02-03 Project Skeleton - PostgreSQL","description":"PostgreSQL I\u0026rsquo;ve chosen PostgreSQL for the same reason as Kafka: I\u0026rsquo;m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I\u0026rsquo;ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.\nService service.yaml\napiVersion: v1 kind: Service metadata: name: postgres-svc labels: app: postgres-app spec: clusterIP: None ports: - name: \u0026#39;5432\u0026#39; port: 5432 protocol: TCP targetPort: 5432 selector: app: postgres-app Again, a Headless service (as with Kafka).","keywords":["postgres","statefulset","k8s"],"articleBody":"PostgreSQL I’ve chosen PostgreSQL for the same reason as Kafka: I’m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I’ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.\nService service.yaml\napiVersion: v1 kind: Service metadata: name: postgres-svc labels: app: postgres-app spec: clusterIP: None ports: - name: '5432' port: 5432 protocol: TCP targetPort: 5432 selector: app: postgres-app Again, a Headless service (as with Kafka). I should be able to access it through postgres-svc:5432, and I’ll check that later.\nStatefulset statefulset.yaml\napiVersion: apps/v1 kind: StatefulSet metadata: name: postgres labels: app: postgres-app spec: serviceName: postgres-svc replicas: 1 selector: matchLabels: app: postgres-app template: metadata: labels: app: postgres-app spec: containers: - name: postgres-container image: postgres:15 ports: - containerPort: 5432 envFrom: - secretRef: name: postgres-secret volumeMounts: - name: postgresdata mountPath: /var/lib/postgresql/data subPath: data volumeClaimTemplates: - metadata: name: postgresdata spec: accessModes: - \"ReadWriteOnce\" resources: requests: storage: \"10Gi\" One of the issue I had when following an online guide was that the volume was mounted on /data/volume. After destroying my pod, I looked for the table I just created but it was missing. The answer was the mount path, which should have been /var/lib/postgresql/data.\nWhile I was at it, I decided to check the different values accepted by the volume’s accessModes. This parameter is used to restrict who can read and write, and also how many “who\"s. The possible values are:\nReadWriteMany: “rw for everyone”, Unix-style. This is used when multiple pods need to write to the same volume.\nReadWriteOnce is rw for one pod, which is what I need since the volume will always be tied to the same pod.\nReadOnlyMany and ReadOnlyOnce are the read-only variants. I wonder if it is possible to use them to create read-only PostgreSQL instances with a single write instance…\nSecret Finally the secret, already seen in statefulset.yaml as a secretRef. It could have been postgres:postgres, but I’ll try to do better. Also, I will use kustomize for this, as it is integrated with kubernetes.\nkustomization.yaml\napiVersion: kustomize.config.k8s.io/v1beta1 kind: Kustomization resources: - service.yaml - statefulset.yaml secretGenerator: - name: postgres-secret literals: - POSTGRES_DB=sand_db - POSTGRES_USER=sandman - POSTGRES_PASSWORD= generatorOptions: disableNameSuffixHash: true You can see the secretGenerator section, with all the different fields I’m using in the PostgreSQL pod. The password was generated using:\n$ openssl rand -base64 32 The disableNameSuffixHash: true is here because by default, kustomize will generate a secret with a random suffix. Since I want to directly reference that secret in my statefulset.yaml, I disabled it.\nApplying Once all the files are created, deploying PostgreSQL is simple:\n$ k apply -k . $ k get pods NAME READY STATUS RESTARTS AGE postgres-0 1/1 Running 3 (3h20m ago) 3d (The number of restarts corresponds to the number of times I’ve rebooted my computer)\nChecks Check the secret Is the secret properly created?\n$ k get secret postgres-secret -o jsonpath=\"{.data.POSTGRES_PASSWORD}\" | base64 -d GetYourOwnPassword= Of course the password is not GetYourOwnPassword=…\nCheck the network $ k run dig --rm -ti --image arunvelsriram/utils -- bash utils@dig:~$ nslookup postgres-svc Server:\t10.96.0.10 Address:\t10.96.0.10#53 Name:\tpostgres-svc.default.svc.cluster.local Address: 10.244.0.4 utils@dig:~$ dig postgres-0.postgres-svc.default.svc.cluster.local [...] ;; ANSWER SECTION: postgres-0.postgres-svc.default.svc.cluster.local. 30 IN A 10.244.0.4 As with Kafka, I expect to have more IPs if I increase the replicas in the statefulset.yaml.\nCheck PostgreSQL Is the thing I deployed really PostgreSQL?\n$ export POSTGRES_PASSWORD=$(k get secret postgres-secret -o jsonpath=\"{.data.POSTGRES_PASSWORD}\" | base64 -d) $ k run postgresql-dev-client --rm --tty -i --restart='Never' --image docker.io/bitnami/postgresql:15 --env=\"PGPASSWORD=$POSTGRES_PASSWORD\" \\ --command -- psql --host postgres-svc -U sandman -d sand_db -p 5432 sand_db=# \\x Expanded display is on. sand_db=# CREATE TABLE dream (id uuid DEFAULT gen_random_uuid() PRIMARY KEY, name text); CREATE TABLE sand_db=# \\dt List of relations -[ RECORD 1 ]--- Schema | public Name | dream Type | table Owner | sandman sand_db=# INSERT INTO dream (name) VALUES ('Mr Sandman'); INSERT 0 1 sand_db=# SELECT * FROM dream; -[ RECORD 1 ]------------------------------ id | 9fe0ce9a-075e-48ec-92eb-59c42a794d6d name | Mr Sandman Check persistence Now is my data really persisted? This test was quite useful, as it helped my identify the wrong mount path of my volume.\n$ k delete pod postgres-0 pod \"postgres-0\" deleted # check that the pod is automatically recreated $ k get pods NAME READY STATUS RESTARTS AGE postgres-0 1/1 Running 0 17s $ export POSTGRES_PASSWORD=$(k get secret postgres-secret -o jsonpath=\"{.data.POSTGRES_PASSWORD}\" | base64 -d) $ k run postgresql-dev-client --rm --tty -i --restart='Never' --image docker.io/bitnami/postgresql:15 --env=\"PGPASSWORD=$POSTGRES_PASSWORD\" \\ --command -- psql --host postgres-svc -U sandman -d sand_db -p 5432 sand_db=# \\dt List of relations -[ RECORD 1 ]--- Schema | public Name | dream Type | table Owner | sandman sand_db=# SELECT * FROM dream; -[ RECORD 1 ]------------------------------ id | 9fe0ce9a-075e-48ec-92eb-59c42a794d6d name | Mr Sandman Mr Sandman is still here!\nTakeaways Statefulsets are neat, and I want to see how to implement redundancy. But that would be for later…\nChecking early was useful: it helped me weed out the volume configuration bug. Imagine having applications connected to the DB and having no data… That would have been harder to debug!\n","wordCount":"852","inLanguage":"en","datePublished":"2023-02-14T00:00:00Z","dateModified":"2023-02-16T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://gautierenaud.github.io/devops_sandbox/02-03-project-skeleton-postgresql/"},"publisher":{"@type":"Organization","name":"RGDG","logo":{"@type":"ImageObject","url":"https://gautierenaud.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gautierenaud.github.io accesskey=h title="RGDG (Alt + H)">RGDG</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gautierenaud.github.io>Home</a>&nbsp;»&nbsp;<a href=https://gautierenaud.github.io/devops_sandbox/>DevOps Sandbox</a></div><h1 class=post-title>02-03 Project Skeleton - PostgreSQL</h1><div class=post-meta><span title='2023-02-14 00:00:00 +0000 UTC'>February 14, 2023</span>&nbsp;·&nbsp;4 min</div></header><div class=post-content><h1 id=postgresql>PostgreSQL<a hidden class=anchor aria-hidden=true href=#postgresql>#</a></h1><p>I&rsquo;ve chosen <a href=https://www.postgresql.org/>PostgreSQL</a> for the same reason as Kafka: I&rsquo;m used to it from my day-to-day work. I will also use a Statefulset for this deployment, but I&rsquo;ll leave the redundancy for later. As with KRaft, I learned the hard way that redundancy is not magical, but that I need to configure it myself.</p><h2 id=service>Service<a hidden class=anchor aria-hidden=true href=#service>#</a></h2><p><code>service.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusterIP</span>: <span style=color:#ae81ff>None</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  	- <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;5432&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres-app</span>
</span></span></code></pre></div><p>Again, a Headless service (as with Kafka). I should be able to access it through <code>postgres-svc:5432</code>, and I&rsquo;ll check that later.</p><h2 id=statefulset>Statefulset<a hidden class=anchor aria-hidden=true href=#statefulset>#</a></h2><p><code>statefulset.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>StatefulSet</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres-app</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>postgres-svc</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres-app</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres-app</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-container</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:15</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>envFrom</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>secretRef</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-secret</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgresdata</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>subPath</span>: <span style=color:#ae81ff>data</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumeClaimTemplates</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgresdata</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>storage</span>: <span style=color:#e6db74>&#34;10Gi&#34;</span>
</span></span></code></pre></div><p>One of the issue I had when following an online guide was that the volume was mounted on <code>/data/volume</code>. After destroying my pod, I looked for the table I just created but it was missing. The answer was the mount path, which should have been <code>/var/lib/postgresql/data</code>.</p><p>While I was at it, I decided to check the different values accepted by the volume&rsquo;s <code>accessModes</code>. This parameter is used to restrict who can read and write, and also how many &ldquo;who"s. The possible values are:</p><ul><li><p><code>ReadWriteMany</code>: &ldquo;<code>rw</code> for everyone&rdquo;, Unix-style. This is used when multiple pods need to write to the same volume.</p></li><li><p><code>ReadWriteOnce</code> is <code>rw</code> for one pod, which is what I need since the volume will always be tied to the same pod.</p></li><li><p><code>ReadOnlyMany</code> and <code>ReadOnlyOnce</code> are the read-only variants. I wonder if it is possible to use them to create read-only PostgreSQL instances with a single write instance&mldr;</p></li></ul><h2 id=secret>Secret<a hidden class=anchor aria-hidden=true href=#secret>#</a></h2><p>Finally the secret, already seen in <code>statefulset.yaml</code> as a <code>secretRef</code>. It could have been <code>postgres:postgres</code>, but I&rsquo;ll try to do better. Also, I will use <code>kustomize</code> for this, as it is integrated with kubernetes.</p><p><code>kustomization.yaml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>kustomize.config.k8s.io/v1beta1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Kustomization</span>
</span></span><span style=display:flex><span><span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>service.yaml</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>statefulset.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>secretGenerator</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-secret</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>literals</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_DB=sand_db</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_USER=sandman</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>POSTGRES_PASSWORD=&lt;super-duper password&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>generatorOptions</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>disableNameSuffixHash</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>You can see the <code>secretGenerator</code> section, with all the different fields I&rsquo;m using in the PostgreSQL pod. The password was generated using:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ openssl rand -base64 <span style=color:#ae81ff>32</span>
</span></span></code></pre></div><p>The <code>disableNameSuffixHash: true</code> is here because by default, kustomize will generate a secret with a random suffix. Since I want to directly reference that secret in my <code>statefulset.yaml</code>, I disabled it.</p><h2 id=applying>Applying<a hidden class=anchor aria-hidden=true href=#applying>#</a></h2><p>Once all the files are created, deploying PostgreSQL is simple:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k apply -k .
</span></span><span style=display:flex><span>$ k get pods
</span></span><span style=display:flex><span>NAME           READY   STATUS    RESTARTS         AGE
</span></span><span style=display:flex><span>postgres-0     1/1     Running   <span style=color:#ae81ff>3</span> <span style=color:#f92672>(</span>3h20m ago<span style=color:#f92672>)</span>    3d
</span></span></code></pre></div><p>(The number of restarts corresponds to the number of times I&rsquo;ve rebooted my computer)</p><h2 id=checks>Checks<a hidden class=anchor aria-hidden=true href=#checks>#</a></h2><h3 id=check-the-secret>Check the secret<a hidden class=anchor aria-hidden=true href=#check-the-secret>#</a></h3><p>Is the secret properly created?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k get secret postgres-secret -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.POSTGRES_PASSWORD}&#34;</span> | base64 -d
</span></span><span style=display:flex><span>GetYourOwnPassword<span style=color:#f92672>=</span>
</span></span></code></pre></div><p>Of course the password is not <code>GetYourOwnPassword=</code>&mldr;</p><h3 id=check-the-network>Check the network<a hidden class=anchor aria-hidden=true href=#check-the-network>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k run dig --rm -ti --image arunvelsriram/utils -- bash
</span></span><span style=display:flex><span>utils@dig:~$ nslookup postgres-svc
</span></span><span style=display:flex><span>Server:		10.96.0.10
</span></span><span style=display:flex><span>Address:	10.96.0.10#53
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Name:	postgres-svc.default.svc.cluster.local
</span></span><span style=display:flex><span>Address: 10.244.0.4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>utils@dig:~$ dig postgres-0.postgres-svc.default.svc.cluster.local
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>;; ANSWER SECTION:
</span></span><span style=display:flex><span>postgres-0.postgres-svc.default.svc.cluster.local. <span style=color:#ae81ff>30</span> IN A 10.244.0.4
</span></span></code></pre></div><p>As with Kafka, I expect to have more IPs if I increase the replicas in the <code>statefulset.yaml</code>.</p><h3 id=check-postgresql>Check PostgreSQL<a hidden class=anchor aria-hidden=true href=#check-postgresql>#</a></h3><p>Is the thing I deployed really PostgreSQL?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export POSTGRES_PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>k get secret postgres-secret -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.POSTGRES_PASSWORD}&#34;</span> | base64 -d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ k run postgresql-dev-client --rm --tty -i --restart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Never&#39;</span> --image docker.io/bitnami/postgresql:15 --env<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;PGPASSWORD=</span>$POSTGRES_PASSWORD<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--command -- psql --host postgres-svc -U sandman -d sand_db -p <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># \x</span>
</span></span><span style=display:flex><span>Expanded display is on.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># CREATE TABLE dream (id uuid DEFAULT gen_random_uuid() PRIMARY KEY, name text);</span>
</span></span><span style=display:flex><span>CREATE TABLE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># \dt</span>
</span></span><span style=display:flex><span>List of relations
</span></span><span style=display:flex><span>-<span style=color:#f92672>[</span> RECORD <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>---
</span></span><span style=display:flex><span>Schema | public
</span></span><span style=display:flex><span>Name   | dream
</span></span><span style=display:flex><span>Type   | table
</span></span><span style=display:flex><span>Owner  | sandman
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># INSERT INTO dream (name) VALUES (&#39;Mr Sandman&#39;);</span>
</span></span><span style=display:flex><span>INSERT <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># SELECT * FROM dream;</span>
</span></span><span style=display:flex><span>-<span style=color:#f92672>[</span> RECORD <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>------------------------------
</span></span><span style=display:flex><span>id   | 9fe0ce9a-075e-48ec-92eb-59c42a794d6d
</span></span><span style=display:flex><span>name | Mr Sandman
</span></span></code></pre></div><h3 id=check-persistence>Check persistence<a hidden class=anchor aria-hidden=true href=#check-persistence>#</a></h3><p>Now is my data really persisted? This test was quite useful, as it helped my identify the wrong mount path of my volume.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ k delete pod postgres-0
</span></span><span style=display:flex><span>pod <span style=color:#e6db74>&#34;postgres-0&#34;</span> deleted
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># check that the pod is automatically recreated</span>
</span></span><span style=display:flex><span>$ k get pods
</span></span><span style=display:flex><span>NAME                    READY   STATUS    RESTARTS         AGE
</span></span><span style=display:flex><span>postgres-0              1/1     Running   <span style=color:#ae81ff>0</span>                17s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ export POSTGRES_PASSWORD<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>k get secret postgres-secret -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{.data.POSTGRES_PASSWORD}&#34;</span> | base64 -d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ k run postgresql-dev-client --rm --tty -i --restart<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Never&#39;</span> --image docker.io/bitnami/postgresql:15 --env<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;PGPASSWORD=</span>$POSTGRES_PASSWORD<span style=color:#e6db74>&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--command -- psql --host postgres-svc -U sandman -d sand_db -p <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># \dt</span>
</span></span><span style=display:flex><span>List of relations
</span></span><span style=display:flex><span>-<span style=color:#f92672>[</span> RECORD <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>---
</span></span><span style=display:flex><span>Schema | public
</span></span><span style=display:flex><span>Name   | dream
</span></span><span style=display:flex><span>Type   | table
</span></span><span style=display:flex><span>Owner  | sandman
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sand_db<span style=color:#f92672>=</span><span style=color:#75715e># SELECT * FROM dream;</span>
</span></span><span style=display:flex><span>-<span style=color:#f92672>[</span> RECORD <span style=color:#ae81ff>1</span> <span style=color:#f92672>]</span>------------------------------
</span></span><span style=display:flex><span>id   | 9fe0ce9a-075e-48ec-92eb-59c42a794d6d
</span></span><span style=display:flex><span>name | Mr Sandman
</span></span></code></pre></div><p>Mr Sandman is still here!</p><h2 id=takeaways>Takeaways<a hidden class=anchor aria-hidden=true href=#takeaways>#</a></h2><p>Statefulsets are neat, and I want to see how to implement redundancy. But that would be for later&mldr;</p><p>Checking early was useful: it helped me weed out the volume configuration bug. Imagine having applications connected to the DB and having no data&mldr; That would have been harder to debug!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://gautierenaud.github.io/tags/postgres/>postgres</a></li><li><a href=https://gautierenaud.github.io/tags/statefulset/>statefulset</a></li><li><a href=https://gautierenaud.github.io/tags/k8s/>k8s</a></li></ul><nav class=paginav><a class=prev href=https://gautierenaud.github.io/devops_sandbox/02-02-project-skeleton-kafka/><span class=title>« Prev</span><br><span>02-02 Project Skeleton - Kafka</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://gautierenaud.github.io>RGDG</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>